<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorator="~{layout/layout}">

<th:block layout:fragment="css">

</th:block>

<th:block layout:fragment="content">
    <main>
        <section class="bg-white position-relative">
            <div class="container py-9 pt-lg-12 position-relative z-index-1">
                <div class="row align-items-center justify-content-center">
                    <div class=" col-xl-4 col-lg-5 col-md-6 col-sm-8 z-index-2">
                        <h2 class="mb-2 display-6">
                            비밀번호를 <br> 잊어버리셨나요?
                        </h2>
                        <p class="text-muted">
                            가입할때 입력한 전화번호를 통해 비밀번호를 재 설정 할 수 있습니다
                        </p>
                        <div class="position-relative">
                            <div>
                                <form action="/updatePwd" method="post">
                                    <!-- csrf 처리 -->
                                    <input th:name="${_csrf.parameterName}" type="hidden" th:value="${_csrf.token}">
                                    <!-- /csrf 처리 -->

                                    <!-- phoneNum -->
                                    <input type="hidden" name="phoneNum">
                                    <!-- phoneNum -->

                                    <!-- password -->
                                    <div class="input-icon-group mb-3 d-none">
                                        <!-- icon -->
                                        <span class="input-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                                                class="bi bi-key" viewBox="0 0 16 16">
                                                <path
                                                    d="M0 8a4 4 0 0 1 7.465-2H14a.5.5 0 0 1 .354.146l1.5 1.5a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0L13 9.207l-.646.647a.5.5 0 0 1-.708 0L11 9.207l-.646.647a.5.5 0 0 1-.708 0L9 9.207l-.646.647A.5.5 0 0 1 8 10h-.535A4 4 0 0 1 0 8zm4-3a3 3 0 1 0 2.712 4.285A.5.5 0 0 1 7.163 9h.63l.853-.854a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.793-.793-1-1h-6.63a.5.5 0 0 1-.451-.285A3 3 0 0 0 4 5z" />
                                                <path d="M4 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0z" />
                                            </svg>
                                        </span>
                                        <!-- icon -->

                                        <input type="password" class="form-control" name="password" required
                                            placeholder="새 비밀번호">
                                        <div id="newPasswordValid"></div>
                                    </div>
                                    <!-- password -->

                                    <!-- password check -->
                                    <div class="input-icon-group mb-3 d-none">
                                        <!-- icon -->
                                        <span class="input-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                                                class="bi bi-key" viewBox="0 0 16 16">
                                                <path
                                                    d="M0 8a4 4 0 0 1 7.465-2H14a.5.5 0 0 1 .354.146l1.5 1.5a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0L13 9.207l-.646.647a.5.5 0 0 1-.708 0L11 9.207l-.646.647a.5.5 0 0 1-.708 0L9 9.207l-.646.647A.5.5 0 0 1 8 10h-.535A4 4 0 0 1 0 8zm4-3a3 3 0 1 0 2.712 4.285A.5.5 0 0 1 7.163 9h.63l.853-.854a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.793-.793-1-1h-6.63a.5.5 0 0 1-.451-.285A3 3 0 0 0 4 5z" />
                                                <path d="M4 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0z" />
                                            </svg>
                                        </span>
                                        <!-- icon -->

                                        <input type="password" class="form-control" id="passwordCheck" required
                                            placeholder="새 비밀번호 확인">
                                        <div id="passwordCheckValid"></div>
                                    </div>
                                    <!-- password check -->

                                    <!-- 인증요청 버튼 -->
                                    <div class="d-grid">
                                        <a href="#modalForm" data-bs-toggle="modal" aria-expanded="false"
                                            class="btn btn-primary">본인인증</a>
                                    </div>
                                    <!-- 인증요청 버튼 -->

                                    <!-- 비밀번호 변경 버튼 -->
                                    <div class="d-grid">
                                        <button type="button" id="submit" class="btn btn-primary d-none">비밀번호 변경</button>
                                        <button type="submit" class="btn btn-primary d-none"></button>
                                    </div>
                                    <!-- 비밀번호 변경 버튼 -->
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- modal start -->
        <div class="modal fade" id="modalForm" tabindex="-1" aria-labelledby="modalFormLabel" aria-hidden="true"
            data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0">
                    <div class="position-relative border-0 pe-4">
                        <button type="button"
                            class="btn-close position-absolute end-0 top-0 me-3 mt-3 size-40 p-0 center-both rounded-circle bg-tint-primary z-index-1"
                            data-bs-dismiss="modal" aria-label="Close">
                            <i class="bi bi-x fs-5"></i>
                        </button>
                    </div>
                    <div class="modal-body py-5 border-0">
                        <div class="px-3">
                            <h2 class="mb-1 display-6">
                                본인인증
                            </h2>
                            <h5 class="mb-4 text-muted">
                                인증을 위해 전화번호를 입력해주세요
                            </h5>
                            <div class="position-relative">
                                <div>
                                    <div class="input-icon-group mb-3">
                                        <span class="input-icon">
                                            <span class="icon-Phone-SMS"></span>
                                        </span>
                                        <input type="text" data-format="custom" name="modalPhoneNum" data-delimiter="-"
                                            data-blocks="3 4 4" placeholder="전화번호" autofocus class="form-control">
                                    </div>
                                    <div class="input-icon-group mb-3 d-none">
                                        <span class="input-icon">
                                            <span class="input-icon">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                                                    class="bi bi-key" viewBox="0 0 16 16">
                                                    <path
                                                        d="M0 8a4 4 0 0 1 7.465-2H14a.5.5 0 0 1 .354.146l1.5 1.5a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0L13 9.207l-.646.647a.5.5 0 0 1-.708 0L11 9.207l-.646.647a.5.5 0 0 1-.708 0L9 9.207l-.646.647A.5.5 0 0 1 8 10h-.535A4 4 0 0 1 0 8zm4-3a3 3 0 1 0 2.712 4.285A.5.5 0 0 1 7.163 9h.63l.853-.854a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.793-.793-1-1h-6.63a.5.5 0 0 1-.451-.285A3 3 0 0 0 4 5z" />
                                                    <path d="M4 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0z" />
                                                </svg>
                                            </span>
                                        </span>
                                        <input type="text" class="form-control" name="modalCheckNum" placeholder="인증번호">
                                    </div>

                                    <div class="d-grid">
                                        <button class="btn btn-primary" name="modalCheckBtn" type="button">
                                            인증요청
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- modal end -->
    </main>
</th:block>

<th:block layout:fragment="script">
    <!-- template input format -->
    <script th:src="@{/assets/vendor/cleave.js/cleave.min.js}"></script>
    <script th:src="@{/assets/js/custom/cleave.js}"></script>
    <script>
        $(function(){
            // ====================== 전화번호 인증 구현 ======================
            
            const phoneReg = /^01([0|1|6|7|8|9])-?([0-9]{4})-?([0-9]{4})$/; // 전화번호 정규식
            let modalPhoneNum = $('[name="modalPhoneNum"]'); // modal 안의 전화번호 input
            let modalCheckNum = $('[name="modalCheckNum"]'); // modal 안의 인증번호 input
            let resultCheckNum = null; // 발송된 인증번호

            const passwordReg =
                /^(?=.*[a-zA-z])(?=.*[0-9])(?=.*[$`~!@$!%*#^?&\\(\\)\-_=+]).{8,16}$/; // 비밀번호 정규식
            let newPassword = $('[name="password"]'); // 새 비밀번호
            let newPasswordValid = $('#newPasswordValid'); // 새 비밀번호 유효성 검사
            let passwordCheck = $('#passwordCheck'); // 새 비밀번호 확인
            let passwordCheckValid = $('#passwordCheckValid'); // 새 비밀번호 확인 유효성 검사
           
            // modal이 꺼질때 실행하는 function
            $('#modalForm').on('hidden.bs.modal', () => {
                // modal안의 요소들 초기화
                $(modalPhoneNum).val('');
                $(modalCheckNum).val('');
                resultCheckNum = null;
                $('[name="modalCheckBtn"]').text('인증요청');
                $(modalCheckNum).parent().addClass('d-none');
            });
    
            // 전화번호 인증
            $('[name="modalCheckBtn"]').on('click', (e) => {
                let modalBtn = e.target; // modal 안의 인증버튼
    
                // 1. 인증버튼(modalBtn)의 text가 '인증요청'이라고 되어있을 경우
                //  1-1) 입력한 전화번호의 형식이 알맞은지 확인한다
                //    false => alert창을 띄우고 function을 종료한다
                //    true => 아래 과정을 실행한다 
                //  1-2) 인증번호를 입력하는 input태그(modalCheckNum)를 보이게 한다
                //  1-3) 인증버튼(modalBtn)의 text를 '인증완료'로 변경한다
                //  1-4) ajax통신으로 생성된 인증번호를 resultCheckNum에 저장한다
    
                // 1.
                if ($(modalBtn).text().trim() == "인증요청") {
                    // 1-1) false
                    if (!phoneReg.test($(modalPhoneNum).val())) {
                        swal('전화번호를 확인해주세요', '', 'error');
                        $(modalPhoneNum).focus();
                        return;
                    }
                    // 1-2)
                    $(modalCheckNum).parent().removeClass('d-none');
                    // 1-3)
                    $(modalBtn).text('인증완료');
                    // 1-4)
                    // 자꾸하면 돈 나간다?!?!
                    $.ajax({
                        url: '/certificate/phoneNumCheck',
                        method: 'post',
                        data: JSON.stringify({
                            to: $(modalPhoneNum).val().replaceAll('-', ''),
                            from: '01096400615',
                        }),
                        dataType: 'json',
                        contentType: 'application/json;charset="utf-8"',
                        success: (result) => {
                            resultCheckNum = result;
                            // console.log(result);
                        },
                        error: (error) => {
                            console.log(error);
                        }
                    });
    
                    // 2. 인증버튼(modalBtn)의 text가 '인증완료'라고 되어있을 경우
                    //  2-1) 발송된 인증번호(resultCheckNum)와 입력한 인증번호(modalCheckNum)를 비교한다
                    //    true => a. 인증완료 alert()를 띄운다
                    //    false => 인증실패 alert()를 띄운다
    
                    // 2.
                } else {
                    // swal('인증이 완료되었습니다!', '', 'success');
                    //     $(newPassword).closest('div').removeClass('d-none');
                    //     $(passwordCheck).closest('div').removeClass('d-none');
                    //     $('[name="phoneNum"]').val($(modalPhoneNum).val());
                    //     $('#submit').removeClass('d-none');
                    //     $('[href="#modalForm"]').addClass('d-none');
                    //     $('#modalForm').modal('hide');
                    // 2-1) true
                    if (resultCheckNum == $(modalCheckNum).val()) {
                        // a.
                        swal('인증이 완료되었습니다!', '', 'success');
                        $(newPassword).closest('div').removeClass('d-none');
                        $(passwordCheck).closest('div').removeClass('d-none');
                        $('#modalForm').modal('hide');
                        // 2-1) false
                    } else {
                        swal('인증에 실패했습니다..!', '', 'error');
                    }
                }
            });
            // ====================== 전화번호 인증 구현 ======================


            // ====================== 비밀번호 update ======================

            // password 유효성 초기화 function
            function newPasswordValidInit() {
                $(newPassword).removeClass('is-valid is-invalid');
                $(newPasswordValid).removeClass('invalid-feedback valid-feedback');
                $(newPasswordValid).empty();
            }

            function passwordCheckValidInit() {
                $(passwordCheck).removeClass('is-valid is-invalid');
                $(passwordCheckValid).removeClass('invalid-feedback valid-feedback');
                $(passwordCheckValid).empty();
            }

            $(newPassword).on("propertychange change keyup paste input", (e)=>{
                let realTimeVal = e.target;

                if($(realTimeVal).val() == '' || $(realTimeVal).val() == null){
                    newPasswordValidInit();
                    return;
                }
                
                if (passwordReg.test($(realTimeVal).val())) {
                    newPasswordValidInit();
                    $(newPassword).addClass('is-valid');
                    $(newPasswordValid).addClass('valid-feedback');
                    $(newPasswordValid).text('사용가능한 비밀번호입니다');
                    return;
                } else {
                    newPasswordValidInit();
                    $(newPassword).addClass('is-invalid');
                    $(newPasswordValid).addClass('invalid-feedback');
                    $(newPasswordValid).text('8~16이자 이내 영어, 숫자, 특수문자를 하나 이상 포함해주세요');
                    return;
                }
            });

            $(passwordCheck).on("propertychange change keyup paste input", (e)=>{
                let realTimeVal = e.target;

                if($(realTimeVal).val() == $(newPassword).val()){
                    passwordCheckValidInit();
                    $(passwordCheck).addClass('is-valid');
                    $(passwordCheckValid).addClass('valid-feedback');
                    $(passwordCheckValid).text('비밀번호가 같습니다');
                    
                } else {
                    passwordCheckValidInit();
                    $(passwordCheck).addClass('is-invalid');
                    $(passwordCheckValid).addClass('invalid-feedback');
                    $(passwordCheckValid).text('비밀번호가 다릅니다');
                    return;
                }
            });

            $('#submit').on('click', (e)=>{
                e.preventDefault();
                if($(passwordCheck).hasClass('is-valid') && $(newPassword).hasClass('is-valid')){
                    $.ajax({
                        url: '/certificate/phoneCheck',
                        method: 'post',
                        data: {
                            phoneNum: $('input[name="phoneNum"]').val()
                        },
                        success: (result)=>{
                            if(result == 0){
                                swal('가입되지 않은 회원입니다','','error')
                                .then(()=>{
                                    location.href = "/login";
                                });
                            }
                            else{
                                swal('성공적으로 변경 되었습니다!','','success');
                                $('button[type="submit"]').click();
                            }
                        },
                        error: (err)=>{
                            console.log(err);
                        }
                    })
                }
            });
            // ====================== 비밀번호 update ======================
        });
    </script>
</th:block>

</html>