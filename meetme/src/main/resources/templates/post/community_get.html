<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{layout/layout}">
<!-- 컨텐츠페이지의 CSS 영역이 들어감 -->
    <th:block layout:fragment="css">
		<style>
			.container{
						background-color:white;
					}
			#profileImg{
				width: 2rem;
				height: 2rem;
			}
		</style>
	</th:block>
	<th:block layout:fragment="content">
		<!-- 여기에 body에 들어갈 내용을 적어주세요 -->
		<div class="container" >
			<br>
			<div>
				<h2 th:text="${list.postTitle}"></h2>
			</div>
			<div class="row mt-3 d-flex justify-content-end"> 
				<div class="col-auto d-flex justify-content-end">
					<form action="/post/updateCommunity" method="get" class="mr-1">
						<input type="hidden" name="postId" id="postId" th:value="${list.postId}">
						<button id="btnUpdate" class="btn btn-primary btn-sm">수정하기</button> 
					</form>
					<!--삭제시 모달-->
					<button id="btnDelete" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteModal" >
						삭제하기
					</button> 	
				</div> 
			</div>
			<br>
			<hr>
			<div style="text-align: right ;">
				<h7 th:text="|작성자:  ${list.nickname}|"></h7>
				<h7 th:text="|조회수: ${list.hit}|"></h7>
			</div>
			<br>
			<div class="form-group">
				<div class="col-sm-10">
					<th:block th:utext="${list.postContent}"></th:block>
					<!-- <textarea name="postContent" class="form-control" id="ckcontents" th:text="${list.postContent}" disabled></textarea> -->
				</div>		
			</div>
			<br>
			<hr>
			<br>
			<!--댓글 넣기-->
			<!-- 댓글조회 -->
			<div class="card shadow mb-4">
				<div class="card-header">
				   <i class="fa fa-comment fa"></i> 댓 글 조 회
				</div>
				<div class="card-body">
				   <div id="commentsBody">
					   <div th:each="list : ${cmt}" class="d-flex justify-content-between commentWrap">
							<img class="d-flex arounded-circle" src="${list.imgId}" alt="프로필 이미지" id="profileImg">
							<span class="pl-2" th:text="${list.userId}"></span>
							<span class="pl-2" th:text="${list.comContent}"></span>
							<!--댓글 작성자만 삭제, 수정 보이게 -->
							<!--<div th:if="${session.userId == cmt[0.userId">-->
							<div>
								<input type="hidden" th:name="commentId" th:value="${list.commentId}">
								<button type="button" class="cmtUpdBtn btn btn-primary btn-sm">
									<i class="far fa-edit"></i>수정하기</button> 
							<!--삭제시 alert-->
								<button type="button" class="cmtDelBtn btn btn-danger btn-sm" th:data-cId="${list.commentId}">
									<i class="far fa-trash-alt"></i>삭제하기</button> 
							</div>
					   </div>
				   </div>
				</div>
			 </div>
			 <!-- 댓글 입력 -->
			 <div class="card mb-2">
				<div class="card-header bg-light">
				   <i class="fa fa-comment fa"></i> 댓 글 달 기
				</div>
				<div class="card-body">
					<ul class="list-group list-group-flush">
						<li class="list-group-item">
							<img class="rounded-circle" src="img/undraw_profile_1.svg" style="width: 2.5rem; height:2.5rem;">
							<!--로그인 한 사람이 댓글 달 수 있게 만들기!-->
							<span class="pl-3"style="font-size: 2rem;"></span>
							<p></p>
							<textarea class="form-control" id="cmtContent" rows="3"></textarea>
							<br>	
							<button type="submit" class="cmtInsBtn btn btn-primary btn-md mr-5" style="float:right;">
								댓글 등록
							</button>
						</li>
					</ul>
				</div>
			 </div>
			 <hr>
			 <!-- 댓글 수정하면 보이게 -->
			 <div id="showComUpdate">
				<form id="updateRep" name="updateRep" action="UpdateCommentServ" method="post">
				   <input type="hidden" id="commentId" name="commentId">
				   <input type="text" id="cUpdated" name="comContent">
				   <button type="submit" id="updated" name="updated" class="btn btn-primary btn-md mr-5"
					  onclick="updateCom()">수정하기!</button>
				</form>
			 </div>
	 	

			<br>
			<!--좋아요 버튼 넣기~ -->
			<div class="row mt-3 d-flex justify-content-center"> 
				<div class="col-auto"> 
					<button type = "submit" name = "submit" id="btnSave" class="btn btn-primary">좋아요</button> 
				</div> 
			</div>
			<br>
		</div>


		<!-- Modal -->
		<div class="modal fade " id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
			<!-- <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
				<h4 class="modal-title" id="myModalLabel">Modal title</h4>
			</div> -->
			<div class="modal-body">
				<h6>정말 삭제 하시겠습니까?</h6>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
				<form action="/post/postDelete" method="post">
					<input type="hidden" name="postId" th:value="${list.postId}">
					<button type="submit" class="btn btn-primary">삭제하기</button>
				</form>
			</div>
			</div>
		</div>
		</div>
	</th:block>
	<th:block layout:fragment="script">
		<script src="/js/ckeditor/ckeditor.js"></script>
		<script type="text/javascript" th:inline="javascript">

		// ============ 페이지 로드 ==============
		$(function() { 
			//수정폼 숨기기
			$('#showComUpdate').hide();

			// ============ CKeditor 적용 =================
			CKEDITOR.replace('ckcontents',{ 
				filebrowserUploadUrl: '/post/ckeditor/fileUpload', 
				font_names : "맑은 고딕/Malgun Gothic;굴림/Gulim;돋움/Dotum;바탕/Batang;궁서/Gungsuh;Arial/Arial;Comic Sans MS/Comic Sans MS;Courier New/Courier New;Georgia/Georgia;Lucida Sans Unicode/Lucida Sans Unicode;Tahoma/Tahoma;Times New Roman/Times New Roman;MS Mincho/MS Mincho;Trebuchet MS/Trebuchet MS;Verdana/Verdana",
				font_defaultLabel : "맑은 고딕/Malgun Gothic", 
				fontSize_defaultLabel : "12", 
				// skin : "office2013", 
				language : "ko" 
			}); 
			// ============================

			// ======= 댓글 처리 =========
			let cmtId = null; // 댓글 sequenceId
			let postId = null; // 게시글 sequenceId
			let userId = null; // 로그인한 유저 sequenceId
			let comContent = null; // 댓글 내용

			const cmtDelBtn = $('.cmtDelBtn'); //댓글 삭제 버튼(여러 개가 선택)
			const cmtUpdBtn = $('.cmtUpdBtn'); // 댓글 수정 버튼(여러 개가 선택)
			const cmtInsBtn = $('.cmtInsBtn'); // 댓글 입력 버튼
			console.log(cmtInsBtn);
			
			// 댓글 삭제
			for(let d of cmtDelBtn){
				$(d).on('click', function(){
					cmtId = $(d).attr('data-cId');
					confirmDel(cId);
				})
			}
			// 댓글 수정

			// 댓글 입력
			$(cmtInsBtn).on('click', function(){
				postId = $('#postId').val();
				userId = 1;
				comContent = $('#cmtContent').val();
				data = {
					postId : postId,
					userId : userId,
					comContent : comContent
				}
				console.log(data);
				confirmIns(data);
			})	
		});

		// 댓글 삭제
		function confirmDel(cmtId){
			const comment = $('[data-cId="'+cmtId+'"]').closest(".commentWrap");
			if(confirm('정말 삭제하시겠습니까?')){
				$.ajax({
					url:'/post/delCMComment/' + cmtId,
					type: 'delete',
					success : function(){
						$(comment).remove();
						alert('삭제되었습니다!!');
					}
				});
			}
		}

		// 댓글 입력
		function confirmIns(data){
			$.ajax({
				url : "/post/commentInsert",
				method : "post",
				data : JSON.stringify(data),
				dataType : 'json',
				contentType : 'appication/json',
				success : function(result){
					console.log(result);
				}
			})
		}
		</script>

		
		
		
	</th:block>
</html>