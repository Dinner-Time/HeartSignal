<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="~{layout/layout}">
<!-- 컨텐츠페이지의 CSS 영역이 들어감 -->
<th:block layout:fragment="css">
	<style>
		.container {
			background-color: white;
		}

		#profileImg {
			width: 2rem;
			height: 2rem;
		}

		ul {
			list-style: none;
			padding-left: 0px;
		}
	</style>
</th:block>
<th:block layout:fragment="content">
	<!-- 여기에 body에 들어갈 내용을 적어주세요 -->
	<div class="container">
		<br>
		<div>
			<h2 th:text="${list.postTitle}"></h2>
		</div>
		<div th:if="'${session.userSession.userId}' == '${list.userId}'">
			<div class="row mt-3 d-flex justify-content-end">
				<div class="col-auto d-flex justify-content-end">
					<form action="/post/updateCommunity" method="get" class="mr-1">
						<input type="hidden" name="postId" id="postId" th:value="${list.postId}">
						<button id="btnUpdate" class="btn btn-primary btn-sm">수정하기</button>
					</form>
					<!--삭제시 모달-->
					<button id="btnDelete" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteModal">
						삭제하기
					</button>
				</div>
			</div>
		</div>
		<br>
		<hr>
		<div style="text-align: right ;">
			<h7 th:text="|작성자:  ${list.nickname}|"></h7>
			<h7 th:text="|조회수: ${list.hit}|"></h7>
		</div>
		<br>
		<div class="form-group">
			<div class="col-sm-10">
				<th:block th:utext="${list.postContent}"></th:block>
				<!-- <textarea name="postContent" class="form-control" id="ckcontents" th:text="${list.postContent}" disabled></textarea> -->
			</div>
		</div>
		<br>
		<hr>
		<br>
		<!--댓글 넣기-->
		<!-- 댓글조회 -->
		<div class="card shadow mb-4">
			<div class="card-header">
				<i class="fa fa-comment fa"></i> 댓 글 조 회
			</div>
			<div class="card-body">
				<div id="commentsBody">
					<div th:each="list : ${cmt}" class="d-flex justify-content-between commentWrap">
						<img class="d-flex arounded-circle" src="${list.imgId}" alt="프로필 이미지" id="profileImg">
						<span class="pl-2" th:text="${list.userId}"></span>
						<span class="pl-2" th:id="${list.commentId}" th:text="${list.comContent}"></span>
						<!--댓글 작성자만 삭제, 수정 보이게 -->
						<div th:if="'${session.userSession.userId}' == '${list.userId}'">
							<div>
								<!-- <input type="hidden" th:name="commentId" th:value="${list.commentId}"> -->
								<button type="button" class="cmtUpdBtn btn btn-primary btn-sm"
									th:data-content="${list.comContent}" th:data-commnetId="${list.commentId}"
									data-toggle="modal" data-target="#comUpdateModal">
									<i class="far fa-edit"></i>수정하기</button>
								<!--삭제시 alert-->
								<button type="button" class="cmtDelBtn btn btn-danger btn-sm"
									th:data-cId="${list.commentId}">
									<i class="far fa-trash-alt"></i>삭제하기</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 댓글 입력 -->
		<div class="card mb-2">
			<div class="card-header bg-light">
				<i class="fa fa-comment fa"></i> 댓 글 달 기
			</div>
			<div class="card-body">
				<ul class="list-group list-group-flush">
					<li class="list-group-item">
						<!--로그인시에만 보이기-->
					<li sec:authorize="isAuthenticated()">
						<!--src 안에  ${session.userSession.imgUrl} -->
						<img class="rounded-circle" th:src="@{|/img/africa.png|}" style="width: 2.5rem; height:2.5rem;">
						<span class="pl-3" style="font-size: 1.6rem;" th:text="${session.userSession.nickname}"></span>
						<p></p>
						<textarea class="form-control" id="cmtContent" th:name="comContent" rows="3"></textarea>
						<br>
						<button type="button" class="cmtInsBtn btn btn-primary btn-md mr-5" style="float:right;">
							댓글 등록
						</button>
					</li>
					<!--로그인 안했을 때 보이는 거-->
					<li sec:authorize="!isAuthenticated()">
						<h5>댓글을 달기 위해서는 로그인 해주세요!:)</h5>
					</li>
					</li>
				</ul>
			</div>
		</div>
		<hr>
		<br>
		<!--좋아요 버튼 넣기~ -->
		<div class="row mt-3 d-flex justify-content-center">
			<div class="col-auto">
				<form action="/post/postLike" method="POST">
					<input type="hidden" name="userId" value="${session.userSession.userId}">
					<button type="submit" name="submit" id="likeBtn" class="likeBtn btn btn-primary" >좋아요</button>
				</form>
			</div>
		</div>
		<br>
	</div>


	<!-- 글 삭제 확인 Modal -->
	<div class="modal fade " id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<!-- <div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
					<h4 class="modal-title" id="myModalLabel">Modal title</h4>
				</div> -->
				<div class="modal-body">
					<h6>정말 삭제 하시겠습니까?</h6>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
					<form action="/post/postDelete" method="post">
						<input type="hidden" name="postId" th:value="${list.postId}">
						<button type="submit" class="btn btn-primary">삭제하기</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!--댓글 수정 확인 모달-->
	<div class="modal fade " id="comUpdateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title" id="myModalLabel">댓글 수정하기</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
							aria-hidden="true">×</span></button>
				</div>

				<div class="modal-body">
					<input type="hidden" id="modalCmtId">
					<textarea class="form-control" id="modalCmtContent" rows="3" th:name="modalCmtContent"
						th:value="${modalCmtContent}"></textarea>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
					<button type="submit" class="btn btn-primary" id="comUpdateBtn">수정하기</button>
				</div>

			</div>
		</div>
	</div>

</th:block>
<th:block layout:fragment="script">
	<script src="/js/ckeditor/ckeditor.js"></script>
	<script type="text/javascript" th:inline="javascript">
		var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
		$(document).ajaxSend(function (e, xhr, options) {
			xhr.setRequestHeader(header, token);
		});


		// ============ 페이지 로드 ==============
		$(function () {


			// ============ CKeditor 적용 =================
			CKEDITOR.replace('ckcontents', {
				filebrowserUploadUrl: '/post/ckeditor/fileUpload',
				font_names: "맑은 고딕/Malgun Gothic;굴림/Gulim;돋움/Dotum;바탕/Batang;궁서/Gungsuh;Arial/Arial;Comic Sans MS/Comic Sans MS;Courier New/Courier New;Georgia/Georgia;Lucida Sans Unicode/Lucida Sans Unicode;Tahoma/Tahoma;Times New Roman/Times New Roman;MS Mincho/MS Mincho;Trebuchet MS/Trebuchet MS;Verdana/Verdana",
				font_defaultLabel: "맑은 고딕/Malgun Gothic",
				fontSize_defaultLabel: "12",
				// skin : "office2013", 
				language: "ko"
			});
			// ============================

			// ======= 댓글 처리 =========
			let cmtId = null; // 댓글 sequenceId
			let postId = null; // 게시글 sequenceId
			/*<![CDATA[*/
			let userId = [
				[$ {
					session.userSession.userId
				}]
			];
			/*]]*/
			console.log(userId);
			let comContent = null; // 댓글 내용

			const cmtDelBtn = $('.cmtDelBtn'); //댓글 삭제 버튼(여러 개가 선택)
			const cmtUpdBtn = $('.cmtUpdBtn'); // 댓글 수정 버튼(여러 개가 선택)
			const comUpdateBtn = $('#comUpdateBtn'); //모달안에 수정버튼
			const cmtInsBtn = $('.cmtInsBtn'); // 댓글 입력 버튼

			const modalCmtContent = $('#modalCmtContent');
			const modalCmtId = $('#modalCmtId');
			console.log(cmtInsBtn);

			// 댓글 삭제
			for (let d of cmtDelBtn) {
				$(d).on('click', function () {
					cmtId = $(d).attr('data-cId');
					confirmDel(cmtId);
				})
			}
			// 댓글 수정
			for (let d of cmtUpdBtn) {
				$(d).on('click', function () {
					comContent = $(d).attr('data-content');
					cmtId = $(d).attr('data-commnetId');
					console.log(comContent);
					$(modalCmtContent).val(comContent);
					$(modalCmtId).val(cmtId);

				})
			}
			//모달 안의 수정버튼 클릭 이벤트
			$(comUpdateBtn).on('click', function () {
				confirmUpdate($(modalCmtId).val(), $(modalCmtContent).val());
			})

			// 댓글 입력
			$(cmtInsBtn).on('click', function () {
				postId = $('#postId').val();
				comContent = $('#cmtContent').val();
				data = {
					postId: postId,
					userId: userId,
					comContent: comContent
				}
				console.log(data);
				confirmIns(data);
			})
		});


		//모달의 수정 버튼을 눌렀을 때
		function confirmUpdate(cmtId, comContent) {
			$.ajax({
				url: '/post/commentUpdate',
				type: 'put',
				data: JSON.stringify({
					commentId: cmtId,
					comContent: comContent
				}),
				dataType: "json",
				contentType: "application/json;charset='utf-8'",
				success: function (data) {
					closeModal(data);
				},
				error: function (error) {
					console.log(error);
				}
			});
		}

		//모달 닫고 업데이트!
		function closeModal(data) {
			$(comUpdateModal).modal('hide');
			$(".commentWrap").find("#" + data.commentId).html(data.comContent)
		}

		// 댓글 삭제
		function confirmDel(cmtId) {
			const comment = $('[data-cId="' + cmtId + '"]').closest(".commentWrap");
			if (confirm('정말 삭제하시겠습니까?')) {
				$.ajax({
					url: '/post/delCMComment/' + cmtId,
					type: 'delete',
					success: function () {
						$(comment).remove();
						alert('삭제되었습니다!!');
					}
				});
			}
		}

		// 댓글 입력
		function confirmIns(data) {
			$.ajax({
				url: "/post/insertCMComment",
				method: "post",
				data: JSON.stringify(data),
				dataType: 'json',
				contentType: 'application/json;charset="utf-8"',
				success: function (result) {
					console.log(result);
					insertCallback(result);
				},
				error: function (err) {
					console.log(err);
				}
			})
		}

		function insertCallback(result) {
			let commentWrap = $("<div />")
				.addClass("d-flex justify-content-between commentWrap");
			let profileImg = $("<img />")
				.addClass("d-flex arounded-circle")
				.attr({
					src: result.imgId,
					alt: "프로필 이미지",
					id: "profileImg"
				});
			let nickname = $("<span />").addClass("pl-2").text(result.nickname);
			let comContent = $("<span />").addClass("pl-2").text(result.comContent);

			let btnWrap = $("<div />")
			let updBtn = $("<button />")
				.addClass("cmtUpdBtn btn btn-primary btn-sm")
				.attr("data-content", result.comContent)
				.attr("data-commentId", result.commentId)
				.attr("data-toggle", "modal")
				.attr("data-target", "#comUpdateModal");

			let upIcon = $("<i />").addClass("far fa-edit").text("수정하기");

			$(updBtn).append(upIcon);

			let delBtn = $("<button />")
				.addClass("cmtDelBtn btn btn-danger btn-sm")
				.attr("data-cId", result.commentId);



			let delIcon = $("<i />").addClass("far fa-trash-alt").text("삭제하기");
			$(delBtn).append(delIcon);

			$(btnWrap).append(updBtn, delBtn);
			$(commentWrap).append(profileImg, nickname, comContent, btnWrap);
			$("#commentsBody").append(commentWrap);
		}
	</script>




</th:block>

</html>