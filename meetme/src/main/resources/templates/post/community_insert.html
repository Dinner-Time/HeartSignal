<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="~{layout/layout}">
<!-- 컨텐츠페이지의 CSS 영역이 들어감 -->
<th:block layout:fragment="css">
	<style>
		.container {
			background-color: white;
		}
	</style>
</th:block>


<th:block layout:fragment="content">
	<!-- 여기에 body에 들어갈 내용을 적어주세요 -->
	<div class="container" align="center">
		<br>
		<div > 	
			<br><br><br><br>
			<h2>게시판 글쓰기</h2>
		</div>
		<br>
		<div class="card-content">
			<form class="form-horizontal form-view" th:action="@{/post/insertCommunity}" th:object="${list}"
				method="get">
				<div class="form-group">
					<label for="inp-type-1" class="col-sm-2 control-label">제목</label>
					<div class="col-sm-10">
						<input type="hidden" th:id="userId" th:name="userId" th:value="${session.userSession.userId}">
						<input type="text" th:id="postTitle" th:name="postTitle">
					</div>
				</div>

				<!--코스 가져오기 모달 -> 모달에서 코스 선택하면 버튼 아래에 뜨게 하자! courseVo는 mypage 도메인 패키지 안에 있당. -->
				<div class="form-group">
					<!-- <label for="inp-type-5" class="col-sm-2 control-label">코스 가져오기</label> -->
					<br>
					<div class="col-sm-10" id="modalShow">
						<span>
							<a href="#modalBasic"  id="courseBtn" data-bs-toggle="modal" aria-expanded="false" class="courseBtn btn btn-outline-danger mb-2 me-1">내 코스 가져오기</a>
						</span>
					</div>
					<div class="courseShow d-flex" ></div>
					<br>
				</div>


				<div class="form-group">
					<br>
					<label for="inp-type-5" class="col-sm-2 control-label">내용</label>

					<div class="col-sm-10">
						<input th:name="${_csrf.parameterName}" type="hidden" th:value="${_csrf.token}">
						<textarea name="postContent" class="form-control" id="ckcontents"></textarea>
					</div>

				</div>
				<div class="row mt-3">
					<div class="col-auto mr-auto">
					</div>
					<div class="col-auto">
						<button type="submit" name="submit" id="btnSave" class="btn btn-primary">저장</button>
						<button id="btnCancel" class="btn btn-light">취소</button>
					</div>
				</div>

			</form>


			<!-- 코스 가져오기 모달 -->
			<!--Modal basic-->
                <div class="modal fade " id="modalBasic" tabindex="-1" aria-labelledby="modalBasicLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content border-0">
                            <div class="modal-header border-0 bg-light">
                                <h5 class="modal-title" align="center"> 내 코스 가져오기 </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                    <i class="bi bi-x fs-5 lh-1"></i>
                                </button>
                            </div>
                            <div class="modal-body py-5 border-0" id="modalBody">
                                
                            </div>
                            <div class="modal-footer bg-light border-0">
                                <button type="button" class="btn btn-white btn-sm" data-bs-dismiss="modal">닫기</button>
                                <button type="submit" class="btn btn-primary btn-sm" id="courseInsertBtn">입력하기</button>
                            </div>
                        </div>
                    </div>
                </div>
			

		</div>
	</div>
	<!-- /.card-content -->

</th:block>
<th:block layout:fragment="script">
	<script src="/js/ckeditor/ckeditor.js"></script>
	<script type="text/javascript" th:inline="javascript">

		/*<![CDATA[*/
		$(function () {

			CKEDITOR.replace('ckcontents', {
				uploadUrl: '/post/ckeditor/fileUpload',
				filebrowserUploadUrl: '/post/ckeditor/fileUpload',
				font_names: "맑은 고딕/Malgun Gothic;굴림/Gulim;돋움/Dotum;바탕/Batang;궁서/Gungsuh;Arial/Arial;Comic Sans MS/Comic Sans MS;Courier New/Courier New;Georgia/Georgia;Lucida Sans Unicode/Lucida Sans Unicode;Tahoma/Tahoma;Times New Roman/Times New Roman;MS Mincho/MS Mincho;Trebuchet MS/Trebuchet MS;Verdana/Verdana",
				font_defaultLabel: "맑은 고딕/Malgun Gothic",
				fontSize_defaultLabel: "12",
				// skin : "office2013", 
				language: "ko"
			});
			// ... 


			let userId = userSession.userId;
			const courseBtn = $('#courseBtn');
			const courseInsertBtn = $('#courseInsertBtn');
		

			// 버튼 클릭 if문 넣어주기
			//if "${'.courseShow'} == null"
		/* 		 		<span>
							<a href="#modalBasic"  id="courseBtn" data-bs-toggle="modal" aria-expanded="false" class="courseBtn btn btn-primary">내 코스 가져오기</a>
						</span>

						<!--show title에 값이 있으면 alert!-->
			 		<span th:if="${'.courseShow'} != null">

							<a href="#alertModal"  id="courseBtn" data-bs-toggle="modal" aria-expanded="false" class="courseBtn btn btn-primary">내 코스 가져오기</a>
						</span>  */


		/* 	let modalShow = $('#modalShow');
			let modalBasicShow = $('<a />').addClass("courseBtn btn btn-primary")
								.attr({"id":"courseBtn"})
								.text("내 코스 가져오기")

			let alertModalShow = $('<a />').addClass("courseBtn1 btn btn-primary")
								.attr({"id":"courseBtn"})
								.text("내 코스 가져오기")
			 */
			//코스 선택된게 없을 때
		/* 	if($('.courseShow').html()==""){
				modalShow.append(modalBasicShow)
			}else{//코스 선택 되었을 때
				modalShow.append(alertModalShow)
			}
 */
			//모달 띄울 때 쓸 ajax~!
			$(courseBtn).on('click', function () {
				data =  userId
				console.log(data);
				getCourse(data);
				
			})
			
		/* 	modalBasicShow.on("click", function(){
				$('#modalBasic').modal("show");
				data =  userId
				getCourse(data);
			});
			alertModalShow.on("click", function(){
				$('#alertModal').modal("show");
				console.log('열려라!')
			})
 */


		});
		// ... 
		function saveGallery() {
			if (!confirm("저장하시겠습니까?")) {
				return;
			}
			var formData = new FormData($("form")[0]);
			formData.append("deleteFiles", deleteFileList);
			formData.set("contents", CKEDITOR.instances.contents.getData());
			for (var i = 0; i < inputFileList.length; i++) {
				if (!inputFileList[i].is_delete) {
					formData.append("files", inputFileList[i]);
				}
			}
			for (var pair of formData.entries()) {
				console.log(pair[0] + ', ' + pair[1]);
			}
			$.ajax({
				type: "POST",
				enctype: "multipart/form-data",
				url: "/gallery",
				data: formData,
				dataType: "json",
				processData: false,
				contentType: false,
				success: function (result) {
					if (result.response == "OK") {
						if ($("#id").val() == undefined) {
							alert("저장되었습니다.");
						} else {
							alert("수정되었습니다.");
						}
						location.href = "/gallery/" + result.galleryId;
					} else {
						alert(result.errorMsg);
					}
				},
			});
		}
		/*]]>*/



		function getCourse(data) {

			if($('.courseShow').html()==""){
				//선택된게 없을 때
				$.ajax({
					url: "/post/getMyCourse?userId="+data,
					method: "get",
					// data: data,
					contentType: 'application/json;charset="utf-8"',
					success: function (result) {
						console.log(result);
						getCourseCallback(result);
					},
					error: function (err) {
						console.log(err);
					}
				})
			}else{
				getAlert();
			}

		}


		//선택되어있을 경우 경고창!
		function getAlert(){
			$('#modalBody').empty();
			let courseWrap = $("<div />").addClass(" justify-content-between courseWrap").html("코스는 한 번에 하나만 입력할 수 있어요! <br> 삭제하고 다시 선택하시겠어요?");

			$('#modalBody').append(courseWrap);
		}

		//https://bootstraplovers.com/assan/4.3/demo/src/component-tabbbed-content.html 이거 맨 밑에꺼 써보기~
		//내 코스 모달에 for문 돌려 넣어주기
		function getCourseCallback(result) {
			$('#modalBody').empty();
			let courseWrap = $("<div />").addClass(" justify-content-between courseWrap");
			for (let i of result){
				let courseDiv = $('<div />').addClass("d-flex justify-content-between").attr({'data-name': i.courseName, 'data-id':i.courseId});
				let courseImg = $('<div />').addClass("d-flex justify-content-between courseImg col-3");
				let img =$('<img />').addClass("courseImg")
									.attr({
										src: i.thumbnailHref,
										alt:"코스 이미지",
										id:"courseImg"
									})
				$('.courseImg').append(img);

				let courseContent = $('<div />').addClass("d-flex justify-content-between courseContent col-9");
				//코스제목, 내용, region, 평균비용 넣기
				let courseName = $('<div />').addClass('courseName')
											.text(i.courseName)
				let courseAvg = $('<div />').addClass('courseAvg')
											.text(i.avgCost)
				let courseRegion = $('<div />').addClass('courseRegion')
												.text(i.region)
											
				let cBtn = $('<button />').addClass('cBtn btn btn-primary btn-sm')
										.attr("data-id", i.courseId)
				$(courseContent).append(courseName,courseAvg);
			    $(courseDiv).append(courseImg, courseContent);
				$(courseDiv).click(showTitle)
				$(courseWrap).append(courseDiv);
			}

			$('#modalBody').append(courseWrap);
		}

		//click하면 모달 없어지고 버튼 아래에 선택한 코스 제목 들어감.
		function showTitle(){
			$('#modalBasic').modal("hide");
			let showTitle = $('<div />').addClass('showTitle').text($(this).attr('data-name'));
			let closeBtn = $('<button />').addClass("btn-close")
										  .attr({'type':'button'},{"data-bs-dismiss":"toast"},{"aria-label":"Close"})
										  .on("click", function(){
											  deleteCourse();
										  });
			let icon = $('<i />').addClass("bi bi-x");
			closeBtn.append(icon);
			let hideId = $('<input />').attr({type:"hidden", name: 'courseId'}).val($(this).attr('data-id'))
			$('.courseShow').append(showTitle,closeBtn, hideId);
		}


		function deleteCourse(){
			$('.courseShow').empty();
		}
	</script>

</th:block>

</html>