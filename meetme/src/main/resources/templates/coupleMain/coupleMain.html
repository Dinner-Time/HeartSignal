<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="~{layout/layout}">
<!-- 컨텐츠페이지의 CSS 영역이 들어감 -->
<th:block layout:fragment="css">
	<link rel="stylesheet" type="text/css" href="https://fengyuanchen.github.io/cropperjs/css/cropper.css">
	
	<style>
.upload_btn{overflow:auto;width:100%;}

#resetPhoto{display:none;} /* 사진 첨부하기 버튼 숨김*/ 
.upload_btn .upload, .upload_btn a{float:left; padding: 6px 20px;
  background:#eee;;
  border-radius: 4px;
  color: black;
  cursor: pointer;}
.upload_btn a{ background:#ccc;}
#resetPhoto,#complete,#defaultImage {float:right; padding: 10px 20px;}
.photo_them{position:relative;width:100%;height:420px;background:#eee;margin :10px 0;}

.them_img, .result_box{position:absolute;top:0;left:0;width:100%;height:100%;}
.them_img img, .result_box img{display:block;margin:0 auto;height:100%;}

.btn-circle-ripple::after, .btn-circle-ripple::before{
	z-index: 1;
}
</style>
</th:block>
<th:block layout:fragment="content">
	<!-- 여기에 body에 들어갈 내용을 적어주세요 -->
		<BR>
		<!-- header section -->
		 <section class="position-relative bg-gradient-secondary text-white jarallax" data-jarallax=".3" style="background-image: none;height: 720px;">
                <img th:src="@{/img/873fda76-e9e4-4bac-b497-4743f8e42b4fblob.jpg}" alt="" class="jarallax-img opacity-80">
                 <svg class="position-absolute start-0 bottom-0 w-100" preserveAspectRatio="none" width="900"
                    height="50" viewBox="0 0 1200 167" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M1200 39.6228L1133 26.8851C1067 14.1473 933 -11.3281 800 5.65554C667 22.6392 533 82.0819 400 99.0655C267 116.049 133 90.5737 67 77.836L0 65.0982V167H67C133 167 267 167 400 167C533 167 667 167 800 167C933 167 1067 167 1133 167H1200V39.6228Z"
                        fill="white" />
                </svg>
                <div class="container col-xl-10 col-xxl-8 py-9 py-lg-12">
                    <div class="row pb-7 align-items-center">
                        <div class="col-lg-8 col-xl-7 mx-auto text-center">
                            
                            <br><br><br><br><br><br><br><br><br><br><br>
                            <h1 class="mb-4 display-2">우리는<br>
                                <span class="d-inline-block"
                                    data-typed='{"strings": ["귀염둥이", "방구쟁이", "songhojun", "Agencies", "Creatives"]}'></span>
                            </h1>
                            <!--offcanvas-btn-trigger-->
                            <a class="btn btn-primary" data-bs-toggle="offcanvas" href="#offcanvasEnd" role="button"
                                aria-controls="offcanvasEnd">
                                시작하기<i class="bi bi-chevron-right align-middle lh-1 ms-1"></i>
                            </a>
                            <br>
                        </div>
                    </div>
                </div>
                <!--/.content-->
            </section>
            
            <!-- section 2-->
            <section class="position-relative bg-white">
                <div class="container py-2 py-lg-6">
                        <div class="col-lg-7 mb-4 mx-auto text-center aos-init aos-animate" data-aos="fade-up" data-aos-duration="700">
                            <h2 class="display-2">D+<b class="text-warning" id="coupleDate"></b></h2><br>
                            <h6 class="display-6">우리 사랑한지</h6>
                        </div>
                    <div class="row">
                        <div class="col-lg-5 my-5 mt-auto text-center aos-init aos-animate" data-aos="fade-up" data-aos-delay="100" data-aos-duration="700">
                            <div class="position-relative mb-4 overflow-hidden size-220 mx-auto rounded-circle">
                                <img th:src="@{/img/coupleImage1.jpg}" alt="" class="img-fluid" id="user1Img"> 
                            </div>
                            <div>
                                <h5 class="mb-1" id="nickName1">
                                </h5>
                                <p class="d-block text-primary mb-3" id="birthDate1"></p>
                                </div>
                        </div>
                        
                        <div class="col-lg-2 my-6 text-center aos-init aos-animate" data-aos="fade-up" data-aos-delay="100" data-aos-duration="700">
                        	<div class="position-relative my-8">
                        	
                        	<div class="spinner-grow text-danger spinner-grow-sm" role="status"></div>&nbsp;&nbsp;
                        	<div class="spinner-grow text-danger spinner-grow-sm" role="status"></div>&nbsp;&nbsp;
							<div class="spinner-grow text-danger spinner-grow-sm" role="status"></div>&nbsp;&nbsp;
							<div class="spinner-grow text-danger spinner-grow-sm" role="status"></div>&nbsp;&nbsp;
                            
                            <a href="#findLove"data-bs-toggle="modal" id="heart"
                                class="btn btn-danger btn-circle-ripple p-0 size-70 rounded-pill fs-3 lh-1 center-both  mb-3">
                                <i class="icon-Heart  align-middle"></i>
                            </a>
							
                            </div>
                        		
                        </div>
                        	
                        <div class="col-lg-5 my-5 text-center aos-init aos-animate" data-aos="fade-up" data-aos-delay="100" data-aos-duration="700">
                            <div class="position-relative mb-4 overflow-hidden size-220 mx-auto rounded-circle" id="loveInfo">
                                <img th:src="@{/img/coupleImage1.jpg}" alt="" class="img-fluid" id="user2Img">
                            </div>
                            	<div>
                                <h5 class="mb-1"  id="nickName2">
                                </h5>
                                <p class="d-block text-primary mb-3" id="birthDate2"></p>
                                </div>
                        </div>
                    </div>
                </div>
            </section>
            
                        
            <section class="bg-dark text-white jarallax" data-jarallax=".3">
                <!--Parallax image-->
                <img th:src="@{/img/873fda76-e9e4-4bac-b497-4743f8e42b4fblob.jpg}" class="jarallax-img" alt="">
                <!--Overlay background-->
                <div class="position-absolute w-100 h-100 start-0 top-0 flip-x bg-gradient-secondary opacity-60"></div>
                <!--Divider shape-top-->
                <svg class="position-absolute start-0 top-0" preserveAspectRatio="none" width="100%" height="48"
                    viewBox="0 0 983 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M983 60L942 51.5534C901 42.8155 819 25.6311 737 21.5534C655 17.1845 573 25.6311 491 31.4563C410 37.2816 328 40.1942 246 34.3689C164 28.5437 82 14.2718 41 7.28155L0 -2.86102e-06V-2.86102e-06H41C82 -2.86102e-06 164 -2.86102e-06 246 -2.86102e-06C328 -2.86102e-06 410 -2.86102e-06 491 -2.86102e-06C573 -2.86102e-06 655 -2.86102e-06 737 -2.86102e-06C819 -2.86102e-06 901 -2.86102e-06 942 -2.86102e-06H983V60Z"
                        fill="white" />
                </svg>

                <!--:Container-->
                <div class="container py-7 py-lg-12 position-relative">
                    <div class="row py-4">
                        <div class="col-md-5 me-lg-auto" data-aos="fade-down" data-aos-duration="400">
                            <h2 class="display-4 mb-4 mb-md-0">
                                함께 그리는 <br>
                                우리의 이야기 <br>
                                우리 오늘 뭐해?
                            </h2>
                        </div>
                        <div class="col-md-6 ms-md-auto" data-aos="fade-up" data-aos-delay="100"
                            data-aos-duration="400">
                            <p class="lead w-lg-85 mb-5">
                                D+DAY와 커플 대문사진을 수정할 수 있어요!<br>
                                아래 버튼 누르기
                            </p>
                            <a href="#updateCouple" class="btn btn-rise rounded-pill hover-lift btn-outline-white" data-bs-toggle="modal">
                                <div class="btn-rise-bg bg-white"></div>
                                <div class="btn-rise-text"><span>설정하기</span></div>
                            </a>
                        </div>
                    </div>
                </div>
            </section>
            
		
	<!-- 커플 수정 Modal창  -->
	<div class="modal fade" tabindex="-1" role="dialog" id="updateCouple"
		aria-labelledby="updateCouple" aria-hidden="true" data-bs-backdrop="static">
		<div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
			<div class="modal-content border-0">
				<div class="modal-header">
					<h5 class="modal-title">커플사진 업로드</h5>
					<button type="button" class="btn-close text-reset p-0 m-0 size-40 center-both ms-auto"
                            data-bs-dismiss="modal" aria-label="Close">
                           <i class="bi bi-x fs-5"></i>
                        </button>
				</div>
				<div class="modal-body">
					<div class="photo_box">
						<div class="upload_btn">
							<div class="upload">
								<input type="file" name="photoBtn" class="form-control form-control-sm"
									accept="image/jpeg, image/png" id="photoBtn">
							</div>
							<button type="button" class="btn btn-primary btn-hover-arrow btn-sm" id="defaultImage"><span>기본이미지로 변경</span></button>
							<button type="button" class="btn btn-primary btn-hover-arrow btn-sm" id="resetPhoto"><span>다시 올리기</span></button>
						</div>
						<div class="photo_them">
							<div class="them_img">
								<img id="image" src="">
							</div>
						</div>
						D-DAY설정하기&nbsp;<input type="date" required="required">
						<button type="button"class="btn btn-primary btn-hover-arrow btn-sm" id="complete"><span>업데이트</span></button>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
<!-- 커플 찾기 모달창 -->
<div class="modal fade" id="findLove" tabindex="-1" aria-labelledby="findLove" aria-hidden="true" style="display: none;"
 data-bs-backdrop="static">
     <div class="modal-dialog modal-dialog-centered">
         <div class="modal-content border-0">
             <div class="modal-header border-0 bg-light">
                 <h5 class="modal-title">내커플찾기</h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                     <i class="bi bi-x fs-5 lh-1"></i>
                 </button>
             </div>
             <div class="modal-body"style="padding: 0px;">
                 <div class="position-relative  bg-white shadow-lg overflow-hidden">
                     <div class="position-relative bg-white overflow-hidden">
						<!--Get started image-->
                         <div class="position-relative my-4 overflow-hidden size-180 mx-auto rounded-circle" id="findLoveInfo"
                         style="display:none;">
                                <img src="/img/coupleImage1.jpg" alt="" class="img-fluid">
                            </div>
                     </div>
                     <div class="px-4 bg-white position-relative pt-4">
                         <h4 class="mb-4 text-center" id="nickFind">커플이메일을 입력해주세요</h4>
                         
                             <div class="mb-3">
                                 <input type="email" name="email" placeholder="Email address" class="form-control rounded-pill px-4">
                             		<small class="d-block text-danger my-2" id="noFind"></small>
                             		
                             </div>
                             <div class="d-grid">
                                 <button type="button" class="btn btn-primary rounded-pill hover-shadow btn-hover-arrow hover-lift"
                                 id="search">
                                 <span>검색</span></button>
                             </div>
                             <br> 
                     </div>
                 </div>
             </div>
             <div class="modal-footer bg-light border-0">
                 <button type="button" class="btn btn-white btn-sm" data-bs-dismiss="modal">취소</button>
                 <button type="button" class="btn btn-primary btn-sm">커플신청하기</button>
             </div>
         </div>
     </div>
 </div>



<!--Offcanvas end white-->
                <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasEnd"
                    aria-labelledby="offcanvasEndLabel">
                    <div class="border-bottom offcanvas-header bg-gradient-tint">
                        <button type="button" class="btn-close text-reset p-0 m-0 size-40 center-both ms-auto"
                            data-bs-dismiss="offcanvas" aria-label="Close">
                           X
                        </button>
                    </div>
                    <div class="offcanvas-body p-3 px-xl-4">
                        <ul class="nav flex-column">
                            <li class="nav-item"><a href="#" class="nav-link fs-3">메인</a></li>
                            <li class="nav-item"><a href="#" class="nav-link fs-3">커플로그</a></li>
                            <li class="nav-item"><a href="#" class="nav-link fs-3">코스만들기</a></li>
                            <li class="nav-item"><a href="#" class="nav-link fs-3">chat</a></li>
                            <li class="nav-item"><a href="#" class="nav-link fs-3">설정</a></li>
                        </ul>
                    </div>
                    <div class="offcanvas-footer p-3 px-xl-4 border-top bg-gradient-tint">
                        <ul class="list-unstyled mb-0">
                            <li class="pb-4">
                                <small class="text-muted d-block">Email us:</small>
                                
                                <a href="mailto:company@domain.com"
                                    class="text-dark link-underline fs-5">company@domain.com</a>
                            </li>
                            <li>
                                <ul class="list-inline">
                                    <li class="list-inline-item me-3">
                                        <a href="#" class="fs-5 text-muted"><i class="bi bi-facebook"></i></a>
                                    </li>
                                    <li class="list-inline-item me-3">
                                        <a href="#" class="fs-5 text-muted"><i class="bi bi-twitter"></i></a>
                                    </li>
                                    <li class="list-inline-item me-3">
                                        <a href="#" class="fs-5 text-muted"><i class="bi bi-linkedin"></i></a>
                                    </li>
                                    <li class="list-inline-item">
                                        <a href="#" class="fs-5 text-muted"><i class="bi bi-instagram"></i></a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>

<div class="position-fixed z-index-fixed top-0 start-0 height-20 w-100 bg-transparent rounded-0 border-0 progress-page">
            <progress data-progress="page" value="" max="100"></progress>
        </div>
</th:block>
<th:block layout:fragment="script">
	
	<script src="https://fengyuanchen.github.io/cropper/js/cropper.js"></script>
	<script th:inline='javascript'>
	
	
	$(function() {
			coupleInfo();
			myloveInfo();
			expirationValidation();
			// ${session.userSession.userId}  session의 아이디값 여기 넣기
			// ${session.userSession.coupleStatus}  session의 커플상태 여기 넣기
			// ${session.userSession.coupleId}  session의 커플아이디 여기 넣기
			//let userId= '[[  ]';
			/*<![CDATA[*/
			/*]]*/
			//console.log('유저아이디:'+userId);
			
			
		//커플로그 만료기간 검증
		function expirationValidation() {
		$.ajax({
			url : "validation",
			method : "post",
			dataType : "json",
			data : {
				userId : 1,
				coupleId : 1,
				name : "송호준"
			},
			success : function(datas) {
			console.log(datas);
			 if(datas.subTerm==0){
			 let message= datas.name+"님의 커플로그 만료일은 "
			 +datas.endDate+" 입니다.\n"
			 +"제결제 하시겠습니까?";
			   
			 if (!confirm(message)) {
				 	location="/";
			    } else {
			        location="coupleMain?coupleStatus="+datas.coupleStatus;
			        // 확인(예) 버튼 클릭 시 이벤트
			    }
			 } //if절 끝
			 
			 else if(datas.endDate!=null){ //만료 3일 전 알림
				 let message= datas.name+"님의 커플로그 만료일은 "
					 +datas.endDate+" 입니다.\n"
					 +datas.subTerm+"개월권 제결제 하시겠습니까?";
			 if (!confirm(message)) {
				 return;
			 	} else {
			        location="coupleMain?coupleStatus="+datas.coupleStatus;
			        // 확인(예) 버튼 클릭 시 이벤트
			    }
			 }
			 
			} //callback 끝
		});//ajax 끝
		}; 
		
			//내정보와 커플정보 들고오기
			function coupleInfo() {
				$.ajax({
					url : "coupleInfo/" + 1,
					dataType : "json",
					success : function(datas) {
					console.log(datas);
					$('#nickName1').text(datas.nickName);
					$('#birthDate1').text(datas.birthDay);
					var today = new Date();
					var coupleDate = new Date(datas.coupleDate);
					var gap = today.getTime() - coupleDate.getTime();
					var result = Math.ceil(gap / (1000 * 60 * 60 * 24));
					$('#coupleDate').text(result);

					}
				});
			}; //ajax 끝
			//내 커플의 정보를 들고옵니다.
			function myloveInfo() {
				
				  /* if(coupleStatus=='w'){
					$('#user2Img').attr("src","/img/"+imgUrl);
					$('#nickName2').text("커플정보가 없습니다");
					$('#birthDate2').text("커플매칭을 해주세요");
					$('.spinner-grow').css("display","block");
					$('#heart').css("display","none");
				}    */  
				//user 세션에
				
				$.ajax({
					url : "myloveInfo",
					data : {
						userId : 1,
						coupleId : 1,
						coupleStatus : 'y'
					},
					method : "GET",
					dataType : "json",
					success : function(datas) {
						$('#nickName2').text(datas.nickName);
						$('#birthDate2').text(datas.birthDay);
						console.log(datas);
					}
				});//ajax 끝
			}; 
			
			//디폴트이미지로 업뎃
			$('#defaultImage').on('click', function() {
				$.ajax({
					url : "defaultImage",
					data : {
						coupleId : 1,
					},
					method : "GET",
					success : function(datas) {
						console.log(datas);
						swal(datas, "", "success",{
							button : {
							text : "확인",
							className : "btn btn-primary"
							}
						});
						$('#updateCouple').hide();
						location.href = location.href;
					}
				});//ajax 끝
			});
			
			
			//상대방 이메일 찾기
			$("#search").on('click',function(){
				if ($('input[type="email"]').val() =="") {
					$('#noFind').text("이메일을 입력해주세요.");			
					$('input[type="email"]').focus();
					return;
				}
				
				let email = $("input[type=email]").val();
				console.log(email);
				
				$.ajax({
					url : "findLove",
					data : {email : email},
					method : "GET",
					dataType : "json",
					success : function(datas) {
						console.log(datas);
						if(datas==null){
							$('#noFind').text("사용자가 없습니다. 다시입력해주세요.");
							$('input[type="email"]').focus();
						}else{
							$('#noFind').remove();
							$('#nickFind').text(datas.nickName);
							$('#findLoveInfo').css("display","block");
						}
					},
					error : function() {
						$('#noFind').text("사용자가 없습니다. 다시입력해주세요.");
						$('input[type="email"]').focus();
					},
				});//ajax 끝
			})
			
			
			//커플찾기 모달창 초기화
		 $('#findLove').on('hidden.bs.modal', function () {
               // 실행 할 내용
             $('#noFind').text("");
             $('input[type="email"]').val("");
             $('#findLoveInfo').css("display","none");
             $('#nickFind').text("커플이메일을 입력해주세요");
               console.log("응애!");
           });
			
			
			var cropper;
			// 사진 업로드하기 버튼 cropper 수정
			$('#photoBtn').on('change', function() {
				$('.them_img').empty().append('<img id="image" src="">');
				$('#defaultImage').css("display","none");
				$('#resetPhoto').css("display","block");
				var image = $('#image');
				var imgFile = $('#photoBtn').val();
				var fileForm = /(.*?)\.(jpg|jpeg|png)$/;

				// 이미지가 확장자 확인 후 노출
				if (imgFile.match(fileForm)) {
					var reader = new FileReader();
					reader.onload = function(event) {
					image.attr("src", event.target.result);
					image.css("display","block");
					
					cropper = image.cropper({
					dragMode : 'move',
					viewMode : 3,
					autoCropArea :0.8,
					minContainerHeight : 400,
					minContainerWidth : 400,
					
					minCropBoxWidth : 800,
					minCropBoxHeight:320,
					minCanvasWidth : 400,
					minCanvasHeight:400,
					responsive : true,
					checkCrossOrigin:true,
					autoCropArea:0.5,
					
					restore : false,
					guides : true,
					center : true,
					cropBoxMovable : true,
					cropBoxResizable : false,
					toggleDragModeOnDblclick : false
					});
					};
					reader.readAsDataURL(event.target.files[0]);
				} else {
					swal("이미지 파일(jpg, png형식의 파일)만 올려주세요", "", "error",{
						button : {
							text : "확인",
							className : "btn btn-primary"
						}
					});
					$('#photoBtn').focus();
					return;
				}
			});
			// 사진 다시 올리기 버튼
			$('#resetPhoto').on('click', function() {
				if ($('input[type="file"]').val() != "") {
					$('#photoBtn').val('');
					$('.them_img img').attr('src', '').remove();
					$('.btn_wrap a:last-child').removeClass('bg1');
					$('input[type="file"]').click();
				} else {
					swal('업로드된 사진이 없습니다.', "", "error",{
						button : {
						text : "확인",
						className : "btn btn-primary"
						}
					});
				}
			});
			// 업로드 버튼
			$('#complete').on('click',function() {
				//$('.them_img').append('<div class="result_box"><img id="result" src=""></div>');
			var image = $('#image');
			var result = $('#result');
			var canvas;
			if ($('input[type="file"]').val() != "") {
				canvas = image.cropper('getCroppedCanvas',
				{
					height : 840
				});
				result.attr('src', canvas.toDataURL("image/jpg"));

				canvas.toBlob(function(blob) {
				var formData = new FormData();
				formData.append('uploadFile', blob/*, 'example.png' */);
				
				console.log($('input[type="date"]').val());
				console.log(result);
				console.log(canvas);
				console.log(blob);
				
				if ($('input[type="date"]').val() != ""){
				formData.append('coupleDate',$('input[type="date"]').val());
				
				$.ajax({
					url : "coupleImage",
					method : 'POST',
					data : formData,
					processData : false,
					contentType : false,
					success : function() {
						$('#updateCouple').hide();
						swal('업데이트 성공!', "", "success",{
							button : {
							text : "확인",
							className : "btn btn-primary"
							}
						});
						$('#updateCouple').hide();
						location.href = location.href;
						
					},
					error : function() {
						swal('업로드 실패', "", "error",{
							button : {
							text : "확인",
							className : "btn btn-primary"
							}
						});
						$('.result_box').remove()
					},
				}); 
				}else {
					swal('D-day 날짜를 입력해주세요.', "", "error",{
						button : {
						text : "확인",
						className : "btn btn-primary"
						}
					});
					$('input[type="date"]').focus();
					return;
				}
				})
			} else {
				swal('사진을 업로드 해주세요', "", "error",{
					button : {
					text : "확인",
					className : "btn btn-primary"
					}
				});
				$('input[type="file"]').focus();
				return;
			}
		});

		}); //function 끝
	</script>
</th:block>
</html>